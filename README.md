# Building a Malware Analysis Lab
![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/bb2a1f81-0eb7-4bd0-90f6-d4ee7d3fe72a)





## Introduction

In this project, I go through the letsdefend.io course Building a Malware Analysis Lab. Creating a malware analysis lab is essential for cybersecurity professionals to safely study and understand malware behavior without risking their operational environment. This controlled setup allows for detailed examination of malware samples, aiding in the development of detection and mitigation strategies.

**Objective**
- Installing VirtualBox
- Configuring VirtualBox
- Flare-VM Installation
- Static Malware Analysis
- Dynamic Malware Analysis

<p>&nbsp;</p>
<p>&nbsp;</p>

---

## Installing VirtualBox with Windows ISO
[![Installing VirtualBox](https://github.com/erikhutson1/Malware-Lab/assets/15833874/88d3de90-b6e6-4299-a2cb-b3dea33b90c3)](https://www.virtualbox.org/wiki/Downloads)



In this section, we will be downloading and installing VirtualBox 7.0 using the above link (click the image). In my instance, I will be using the Windows host package. 

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/0723f4bf-0511-4ece-9679-24d746827fe2)


When it's done downloading I went through the installation process and left all settings on default. You will encounter this message where you need to reset your NIC to complete the installation. Just hit Yes to proceed. 

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/26add33a-e104-43d9-9c95-3cb2e6eda5d0)


Followed by needing to install dependencies if you are missing Python Core. I advise hitting yes to install it now rather than wait until later to do it.

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/4831dcc9-0fb7-4d5f-ac19-b059003b9893)

When VirtualBox is finished you can close out of the installation and click the below image to download the Windows 10 Media Creation Tool on the Microsoft website.

[![Windows 10 ISO](https://github.com/erikhutson1/Malware-Lab/assets/15833874/885ffb62-725c-4c64-8c06-20944b2aaa85)](https://go.microsoft.com/fwlink/?LinkId=2265055)

Opening up the Windows Media Creation tool it's **IMPORTANT DO NOT SELECT UPGRADE**

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/e7fa852d-ca78-40e0-a181-ef05a2c9a8a5)

Go through the remaining prompts until you reach the option to "Choose which media to use". Make sure to select "ISO File". This will make it easier to add to VirtualBox in the following steps

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/ccee2ac1-17ed-43c8-863f-2234d572ea26)

When the ISO is finished downloading I went to the location I saved it to and created a new folder named "Windows Storage". This will be used in a minute. 

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/8d2a177f-3e1e-4537-b383-d7438dbaf735)

I opened up VirtualBox and created a new instance naming it "Malware Analysis Lab" chose the "Windows Storage" folder for the virtual machine to use and then pointed the ISO image to the one I downloaded. I also checked to skip "unattended Install" since I don't want to install the guest option as this requires a product key

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/81f3d79e-2306-4091-8c73-de42a30f147f)

Virtual Hardware Specs I went ahead with 8GB of virtual memory and 2 cores but will adjust these if needed.

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/dc42966a-2834-4047-9ca6-14c9548fdcb6)

Since we will be installing Flare-VM I'm going with a minimum of 80GB of virtual disk space to make sure I have enough for the installation

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/5c777345-1326-424d-b2d5-98a99a3b1d55)





<p>&nbsp;</p>
<p>&nbsp;</p>

---




## Configuring VirtualBox
![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/d654e833-13ae-4833-aa63-b692acfbdc15)

I went ahead and started the Virtual Machine and went through the Windows startup prompts until I got to the "product key" section where I selected "I don't have a product key" to move forward

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/83fffd0c-75a2-4bfb-94e4-c162772f4b8c)

I selected "Windows 10 Pro" since I want the features that come with it. Home edition is limited in what you can do so its not advised to use it.

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/fab4e6c0-5859-4b8f-8b5f-61491bfa8997)

**I selected Custom: Install Windows Only** and then pointed the installation to the virtual disk that was created as it should be the only option

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/c4be393f-78d0-4c44-b961-fdaaf1ff2ba4)

Virtual Disk that was created during inital setup

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/a7363b49-fdb4-489a-a2f4-2bd00d025546)


Windows will prompted me to sign in with a Microsoft Account. Skipped this by selecting "offline account" in the bottom left corner. This will take you to another screen trying to get you to do it again. Select "Limited experience" and it will take you to the screen to setup Username and password. 

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/4eb61b9d-c439-4bfd-9321-2ae0a48fcade)

Windows eventually loaded to my desktop and this is when I installed guest addition OS by going into VirtualBox Devices

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/5b8de580-8b3a-41e2-9595-df1787cca0b9)

This added the guest additions to the virtual machine and I navigated to the folder and installed the 64bit edition

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/4291a3a2-01ee-4cfa-8a47-a4e9593766c5)

I don't want Windows quarentining or blocking any of the malware we are going to analyze so I'm going to be modifying the OS to the following. 

- Disable Windows Update
  - Services -> Windows Update -> Stop Service -> Set to Disable
- Disable Windows Defender
  - Windows Security -> Manage Settings
    - Real Time Protection -> Off
    - Cloud Delivered Protection -> Off
    - Automatic Sample Submission -> Off
    - Tamper Protection -> Off 
  - Group Policy (gpedit) -> Administrator Template -> Windows Components
    - Microsoft Defender Anti-Virus -> Real Time Protection
      - Set Turn off real-time protection to "Enabled"
    - Microsoft Defender Anti-Virus
      - Set Turn off Microsoft Defender Antivirus to "Enabled"
- Disbale Hide Extensions
  - File Explorer -> View -> Options -> Change folder and seartch Options -> View
    - Select "Show hidden files, folders and drives"
    - Uncheck "Hide extensions for known file types

Once I completed these last steps I took a snapshot of the virtual machine as a baseline to revert back to if needed.





<p>&nbsp;</p>
<p>&nbsp;</p>

---






## Flare-VM Installation

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/5a203a0a-21eb-48fb-ad25-90c77b81ba7d)

https://github.com/mandiant/flare-vm?tab=readme-ov-file

**FLARE-VM should ONLY be installed on a virtual machine.** The VM should satisfy the following requirements:

- Windows >= 10
- PowerShell >= 5
- Disk capacity of at least 60 GB and memory of at least 2GB
- Usernames without spaces or other special characters
- Internet connection
- Tamper Protection and any Anti-Malware solution (e.g., Windows Defender) Windows Defender disabled, preferably via Group Policy
- Windows Updates Disabled


Some slight changes are needed to the virtual machine prior to installing flare

- Updated CPU count to 2
- Changed Video Memory to 128MB

I went to Flare-VM github and downloaded the installer powershell script after verifying I completed all the pre-reqs


- Opened a PowerShell prompt as administrator
- Downloaded the installation script installer.ps1 to my Desktop folder named "Flare" from the main github page
- Unblock the installation script in powershell:
  - Unblock-File .\install.ps1
- Enable script execution in powershell:
  - Set-ExecutionPolicy Unrestricted -Force
- Executed the installer script in powershell
  - .\install.ps1 -password <password> -noWait -noGui

Making Progress 

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/f0c289c1-8435-47aa-9ea2-79ff3e29162a)





<p>&nbsp;</p>
<p>&nbsp;</p>

---




## Static Malware Analysis





<p>&nbsp;</p>
<p>&nbsp;</p>

---




## Dynamic Malware Analysis





<p>&nbsp;</p>
<p>&nbsp;</p>

---




## Conclusion
