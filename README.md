# Building a Malware Analysis Lab
![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/bb2a1f81-0eb7-4bd0-90f6-d4ee7d3fe72a)





## Introduction

In this project, I go through the letsdefend.io course Building a Malware Analysis Lab. Creating a malware analysis lab is essential for cybersecurity professionals to safely study and understand malware behavior without risking their operational environment. This controlled setup allows for detailed examination of malware samples, aiding in the development of detection and mitigation strategies.

**Objective**
- Installing VirtualBox
- Configuring VirtualBox
- Flare-VM Installation
- Static Malware Analysis
- Dynamic Malware Analysis

<p>&nbsp;</p>
<p>&nbsp;</p>

---

## Installing VirtualBox with Windows ISO
[![Installing VirtualBox](https://github.com/erikhutson1/Malware-Lab/assets/15833874/88d3de90-b6e6-4299-a2cb-b3dea33b90c3)](https://www.virtualbox.org/wiki/Downloads)



In this section, we will be downloading and installing VirtualBox 7.0 using the above link (click the image). In my instance, I will be using the Windows host package. 

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/0723f4bf-0511-4ece-9679-24d746827fe2)


When it's done downloading I went through the installation process and left all settings on default. You will encounter this message where you need to reset your NIC to complete the installation. Just hit Yes to proceed. 

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/26add33a-e104-43d9-9c95-3cb2e6eda5d0)


Followed by needing to install dependencies if you are missing Python Core. I advise hitting yes to install it now rather than wait until later to do it.

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/4831dcc9-0fb7-4d5f-ac19-b059003b9893)

When VirtualBox is finished you can close out of the installation and click the below image to download the Windows 10 Media Creation Tool on the Microsoft website.

[![Windows 10 ISO](https://github.com/erikhutson1/Malware-Lab/assets/15833874/885ffb62-725c-4c64-8c06-20944b2aaa85)](https://go.microsoft.com/fwlink/?LinkId=2265055)

Opening up the Windows Media Creation tool it's **IMPORTANT DO NOT SELECT UPGRADE**

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/e7fa852d-ca78-40e0-a181-ef05a2c9a8a5)

Go through the remaining prompts until you reach the option to "Choose which media to use". Make sure to select "ISO File". This will make it easier to add to VirtualBox in the following steps

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/ccee2ac1-17ed-43c8-863f-2234d572ea26)

When the ISO is finished downloading I went to the location I saved it to and created a new folder named "Windows Storage". This will be used in a minute. 

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/8d2a177f-3e1e-4537-b383-d7438dbaf735)

I opened up VirtualBox and created a new instance naming it "Malware Analysis Lab" chose the "Windows Storage" folder for the virtual machine to use and then pointed the ISO image to the one I downloaded. I also checked to skip "unattended Install" since I don't want to install the guest option as this requires a product key

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/81f3d79e-2306-4091-8c73-de42a30f147f)

Virtual Hardware Specs I went ahead with 8GB of virtual memory and 2 cores but will adjust these if needed.

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/dc42966a-2834-4047-9ca6-14c9548fdcb6)

Since we will be installing Flare-VM I'm going with a minimum of 80GB of virtual disk space to make sure I have enough for the installation

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/5c777345-1326-424d-b2d5-98a99a3b1d55)





<p>&nbsp;</p>
<p>&nbsp;</p>

---




## Configuring VirtualBox
![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/d654e833-13ae-4833-aa63-b692acfbdc15)

I went ahead and started the Virtual Machine and went through the Windows startup prompts until I got to the "product key" section where I selected "I don't have a product key" to move forward

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/83fffd0c-75a2-4bfb-94e4-c162772f4b8c)

I selected "Windows 10 Pro" since I want the features that come with it. Home edition is limited in what you can do so its not advised to use it.

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/fab4e6c0-5859-4b8f-8b5f-61491bfa8997)

**I selected Custom: Install Windows Only** and then pointed the installation to the virtual disk that was created as it should be the only option

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/c4be393f-78d0-4c44-b961-fdaaf1ff2ba4)

Virtual Disk that was created during inital setup

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/a7363b49-fdb4-489a-a2f4-2bd00d025546)


Windows will prompted me to sign in with a Microsoft Account. Skipped this by selecting "offline account" in the bottom left corner. This will take you to another screen trying to get you to do it again. Select "Limited experience" and it will take you to the screen to setup Username and password. 

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/4eb61b9d-c439-4bfd-9321-2ae0a48fcade)

Windows eventually loaded to my desktop and this is when I installed guest addition OS by going into VirtualBox Devices

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/5b8de580-8b3a-41e2-9595-df1787cca0b9)

This added the guest additions to the virtual machine and I navigated to the folder and installed the 64bit edition

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/4291a3a2-01ee-4cfa-8a47-a4e9593766c5)

I don't want Windows quarentining or blocking any of the malware we are going to analyze so I'm going to be modifying the OS to the following. 

- Disable Windows Update
  - Services -> Windows Update -> Stop Service -> Set to Disable
- Disable Windows Defender
  - Windows Security -> Manage Settings
    - Real Time Protection -> Off
    - Cloud Delivered Protection -> Off
    - Automatic Sample Submission -> Off
    - Tamper Protection -> Off 
  - Group Policy (gpedit) -> Administrator Template -> Windows Components
    - Microsoft Defender Anti-Virus -> Real Time Protection
      - Set Turn off real-time protection to "Enabled"
    - Microsoft Defender Anti-Virus
      - Set Turn off Microsoft Defender Antivirus to "Enabled"
- Disbale Hide Extensions
  - File Explorer -> View -> Options -> Change folder and seartch Options -> View
    - Select "Show hidden files, folders and drives"
    - Uncheck "Hide extensions for known file types

Once I completed these last steps I took a snapshot of the virtual machine as a baseline to revert back to if needed.





<p>&nbsp;</p>
<p>&nbsp;</p>

---






## Flare-VM Installation

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/5a203a0a-21eb-48fb-ad25-90c77b81ba7d)

https://github.com/mandiant/flare-vm?tab=readme-ov-file

**FLARE-VM should ONLY be installed on a virtual machine.** The VM should satisfy the following requirements:

- Windows >= 10
- PowerShell >= 5
- Disk capacity of at least 60 GB and memory of at least 2GB
- Usernames without spaces or other special characters
- Internet connection
- Tamper Protection and any Anti-Malware solution (e.g., Windows Defender) Windows Defender disabled, preferably via Group Policy
- Windows Updates Disabled


Some slight changes are needed to the virtual machine prior to installing flare

- Updated CPU count to 2
- Changed Video Memory to 128MB

I went to Flare-VM github and downloaded the installer powershell script after verifying I completed all the pre-reqs


- Opened a PowerShell prompt as administrator
- Downloaded the installation script installer.ps1 to my Desktop folder named "Flare" from the main github page
- Unblock the installation script in powershell:
  - Unblock-File .\install.ps1
- Enable script execution in powershell:
  - Set-ExecutionPolicy Unrestricted -Force
- Executed the installer script in powershell
  - .\install.ps1 -password <password> -noWait -noGui

Making Progress 

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/f0c289c1-8435-47aa-9ea2-79ff3e29162a)

Flare-VM installation was complete 
![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/b78fab12-5e0a-4d26-9e85-5f04e0fde910)


Additional Tools that need to be downloaded 

- FakeNet
  - https://github.com/mandiant/flare-fakenet-ng
- HashMyFiles or HashCalc
  - https://www.nirsoft.net/utils/hash_my_files.html
- Regshot
  - https://sourceforge.net/projects/regshot/ 
- Ghidra
  - https://github.com/NationalSecurityAgency/ghidra/releases   

I took a new baseline snapshot with Flare-VM





<p>&nbsp;</p>
<p>&nbsp;</p>

---




## Static Malware Analysis

Static Malware Analysis Steps

The file starts out as a .bin extension and we need to figure out what the file type is.

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/9fd66c48-0df9-4640-9d98-2d75eac679d7)

<p>&nbsp;</p>

- HxD Tool
  - Signatures to look for to indicate the file is EXE
    - Keywords: MZ, 4D 5A, This program cannot be run in DOS mode

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/dc026de4-3b26-4c6f-bf3c-caf3ff56c704)

- Cmder tool can drag and drop file to also indicate file type or use command
  - Command: file (filename)

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/d67d59ed-643f-4afe-840a-99f680752cb5)

<p>&nbsp;</p>

- Fingerprinting the Malware
  - Grabbed the hash from HashCalc and pasted it into Virus total to get information
  
 ![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/c11ba3f5-e68b-45f7-a5d1-ad5069f52f12)

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/95da508e-19a8-4866-9746-bb622855a753)

- STRINGS
  - IP addresses
  - URLs (C2C)
  - Windows API
  - Base64 or any encoding techniques
  - Command
    - strings -n 5 XMoon.exe > output.txt
    - strings -n 5 XMoon.exe

- Decrypting Encoded Strings
  - Xorsearch
    - Commands:
      - Xorsearch XMoon.exe http
      - Xorsearch XMoon.exe This
      - Xorsearch XMoon.exe Create

- Floss
  - Commands:
    - floss XMoon.exe

- Packing
    - Packing is a technique where malware authors try and use a tool that modifies the formatting of code by compressing or encrypting the data. In order to see if malware is packed, we will use a tool called 'Exeinfo'

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/2c2c17ea-0c57-4bfa-ad60-dfa70eec8923)



<p>&nbsp;</p>
<p>&nbsp;</p>

---




## Dynamic Malware Analysis

I'm going to key in on four different things to look for

- Process Activity
- Network Activity
- Registry Activity
- File Activity

### Process Activity

Tools used
- Process Hacker
- Procmon

After running the malware Process Hacker could not provide any additional information so I let Procmon run for a few minutes to capture activity

Process Hacker could not show any child tasks running for this malware

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/b51abe8e-a516-4416-9b14-05aa1a776f08)

I let Process monitor run for 3-4 minutes to try and capture activity and it captured the malware running powershell and also setting up a scheduled task

**Overall Process Monitor**

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/3c543296-61da-4d68-b37f-c93b917fa1e1)

<p>&nbsp;</p>

**Powershell script**

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/c16986a4-d2eb-4258-8702-574962ef9572)

<p>&nbsp;</p>

**Scheduled Task**

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/9eceb297-1ef0-4ca7-b673-c7ecde3f16eb)

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/5b73cc6a-c210-4b4e-9480-92e96e285cb1)

<p>&nbsp;</p>

### Network Activity

Tools used
- Wireshark
  
I'm going to be looking for any activity that might indicate a command and control server might be in play and for this I'm using wireshark to filter for SMTP, HTTP, DNS.

No activity was shown on SMTP or HTTP, however we do see DNS attempts trying to connect out and failing at a odd entry which we can assume would be the malware trying to reach out to the C2

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/b05cf68d-5f0e-4f95-a465-13531619bbdf)

For demo purposes the IP appears to stem from letsdefend most likely for training purposes as its a private address

### Registry Activity (Persistance)

Tools used
- Regshot
- Procmon

I'm looking for any persistant registry changes using Regshot to see if any keys were added, values added, modified or files added as well as Procmon tool to assist

After running the 2nd shot in Regshot we compare the difference between the first and second 

**Keys Added**

HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree\Updates\VbxFiQYCyFDgGL

HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths\C:\Users\LetsDefend\AppData\Roaming\VbxFiQYCyFDgGL.exe: 0x00000000

HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tasks\{20B274C8-FD14-41A0-8496-895FA44F3A50}\Path: "\Updates\VbxFiQYCyFDgGL"

Going to pay attention to the startup and look for any new keys that look similar to:

- HKCU\Software\Microsoft\Windows\CurrentVersion\Run
- HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce
- HKLM\Software\Microsoft\Windows\CurrentVersion\Run
- HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce

### File Activities

Tools Used
- Regshot
- Procmon

![image](https://github.com/erikhutson1/Malware-Lab/assets/15833874/03bae48c-74a2-4a85-8082-fc4e0b1e7d1c)


Checking for changes to:

- C:\Users\Username\AppData\Roaming\
- $TEMP
- shell:startup
- shell:common startup

<p>&nbsp;</p>
<p>&nbsp;</p>

---




## Conclusion
In this project, I built a malware analysis lab using virtual box and Flare-VM ontop of the Windows OS. I used two different malware samples to conduct research on Static vs Dynamic Malware. The static Malware sample utilized HxD to find out the true extension of the file and CMDer to verify. I then fingerprinted the malware by capturing the hash of it using HashCalc and running it in VirusTotal to get more information from other vendors. For the dynamic segment of this lab we execute another malware sample and monitored four different activities associated with it. Process, Network, Registry and File activity using various tools such as Wireshark and ProcMon to gather real time data and saw that the malware ran powershell to add registry keys and also scheduled task to run an executable everytime the current login user would login. This Malware would try and reach out to a C2 server to send the stolen data.
